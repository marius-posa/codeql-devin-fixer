name: Verify CodeQL Fix

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  verify-fix:
    name: Re-run CodeQL on PR branch
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: >-
      contains(github.event.pull_request.title, 'fix(') &&
      contains(github.event.pull_request.title, 'security issues')

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Detect languages
        id: detect-lang
        shell: bash
        run: |
          LANGS=""
          has_files() {
            local result
            result=$(find . \( "$@" \) -print -quit 2>/dev/null)
            [ -n "$result" ]
          }
          if has_files -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx"; then
            LANGS="${LANGS:+$LANGS,}javascript"
          fi
          if has_files -name "*.py"; then
            LANGS="${LANGS:+$LANGS,}python"
          fi
          if has_files -name "*.java"; then
            LANGS="${LANGS:+$LANGS,}java"
          fi
          if has_files -name "*.go"; then
            LANGS="${LANGS:+$LANGS,}go"
          fi
          if has_files -name "*.rb"; then
            LANGS="${LANGS:+$LANGS,}ruby"
          fi
          if has_files -name "*.cs"; then
            LANGS="${LANGS:+$LANGS,}csharp"
          fi
          if has_files -name "*.cpp" -o -name "*.c"; then
            LANGS="${LANGS:+$LANGS,}cpp"
          fi
          if [ -z "$LANGS" ]; then
            LANGS="javascript"
          fi
          echo "languages=$LANGS" >> "$GITHUB_OUTPUT"
          echo "Detected languages: $LANGS"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ steps.detect-lang.outputs.languages }}
          queries: security-extended

      - name: Build CodeQL database
        uses: github/codeql-action/autobuild@v3

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v3
        id: codeql-analyze
        with:
          output: ${{ runner.temp }}/codeql-verify-results
          upload: never

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Compare results with original findings
        id: compare
        shell: bash
        run: |
          SARIF_DIR="${{ runner.temp }}/codeql-verify-results"
          SARIF_FILE=$(find "$SARIF_DIR" -name "*.sarif" -type f | head -1)

          if [ -z "$SARIF_FILE" ]; then
            echo "No SARIF file found"
            echo "status=no-sarif" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          export SARIF_FILE
          export PR_TITLE="${{ github.event.pull_request.title }}"

          python3 << 'PYEOF'
          import json
          import os
          import re
          import sys

          sarif_file = os.environ.get("SARIF_FILE", "")
          pr_title = os.environ.get("PR_TITLE", "")

          with open(sarif_file) as f:
              sarif = json.load(f)

          issue_count = 0
          remaining = []
          for run in sarif.get("runs", []):
              for result in run.get("results", []):
                  issue_count += 1
                  rule_id = result.get("ruleId", "")
                  msg = result.get("message", {}).get("text", "")
                  locs = []
                  for loc in result.get("locations", []):
                      phys = loc.get("physicalLocation", {})
                      art = phys.get("artifactLocation", {})
                      region = phys.get("region", {})
                      locs.append(f"{art.get('uri', '')}:{region.get('startLine', 0)}")
                  remaining.append({"rule_id": rule_id, "message": msg[:200], "locations": locs})

          ids_match = re.search(r'fix\(([^)]+)\)', pr_title)
          issue_ids = ids_match.group(1).split(",") if ids_match else []

          family_match = re.search(r'resolve (\S+) security issues', pr_title)
          family = family_match.group(1) if family_match else ""

          family_remaining = [r for r in remaining if family and family.lower() in r.get("rule_id", "").lower()]

          with open(os.environ.get("GITHUB_OUTPUT", "/dev/null"), "a") as f:
              f.write(f"total_remaining={issue_count}\n")
              f.write(f"family_remaining={len(family_remaining)}\n")
              f.write(f"targeted_family={family}\n")
              if issue_count == 0:
                  f.write("status=all-resolved\n")
              elif len(family_remaining) == 0 and family:
                  f.write("status=family-resolved\n")
              else:
                  f.write("status=issues-remain\n")

          with open(os.environ.get("GITHUB_STEP_SUMMARY", "/dev/null"), "a") as f:
              f.write(f"## Fix Verification Results\n\n")
              if issue_count == 0:
                  f.write("All CodeQL issues resolved on this branch.\n")
              else:
                  f.write(f"**{issue_count}** CodeQL issue(s) remaining on this branch.\n\n")
                  if family and len(family_remaining) == 0:
                      f.write(f"The targeted **{family}** issues appear resolved.\n")
                  for r in remaining[:20]:
                      f.write(f"- `{r['rule_id']}` at {', '.join(r['locations'][:3])}\n")
                  if len(remaining) > 20:
                      f.write(f"- ... and {len(remaining) - 20} more\n")
          PYEOF

      - name: Label PR based on results
        if: steps.compare.outputs.status != 'no-sarif'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.compare.outputs.status }}';
            const prNumber = context.payload.pull_request.number;

            const labelMap = {
              'all-resolved': 'codeql-verified',
              'family-resolved': 'codeql-partial-fix',
              'issues-remain': 'codeql-needs-work',
            };
            const label = labelMap[status] || 'codeql-needs-work';

            const removeLabels = Object.values(labelMap);
            for (const l of removeLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: l,
                });
              } catch (e) {
                // Label not present, ignore
              }
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: [label],
            });

      - name: Comment on PR with verification results
        if: steps.compare.outputs.status != 'no-sarif'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.compare.outputs.status }}';
            const total = '${{ steps.compare.outputs.total_remaining }}';
            const family = '${{ steps.compare.outputs.targeted_family }}';
            const familyRemaining = '${{ steps.compare.outputs.family_remaining }}';

            let body = '## CodeQL Fix Verification\n\n';
            if (status === 'all-resolved') {
              body += 'All CodeQL security issues have been resolved on this branch.';
            } else if (status === 'family-resolved') {
              body += `The targeted **${family}** issues appear resolved.\n\n`;
              body += `${total} issue(s) from other categories remain.`;
            } else {
              body += `**${total}** CodeQL issue(s) still detected on this branch.\n\n`;
              if (family) {
                body += `${familyRemaining} issue(s) from the **${family}** category remain.`;
              }
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('CodeQL Fix Verification')
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: body,
              });
            }
