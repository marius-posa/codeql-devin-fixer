<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CodeQL Devin Fixer - Telemetry Dashboard</title>
<link rel="stylesheet" href="static/shared.css">
</head>
<body>
<div class="container">
  <header>
    <h1><span>CodeQL Devin Fixer</span> Telemetry</h1>
    <div class="header-actions">
      <button class="btn" onclick="refreshData()" id="btn-refresh">Refresh Data</button>
      <button class="btn btn-primary" onclick="pollSessions()" id="btn-poll">Poll Sessions</button>
      <button class="btn btn-primary" onclick="openDispatchModal()" id="btn-dispatch" style="background:#1f6feb;border-color:#388bfd">Trigger Action</button>
      <button class="btn" onclick="openSettingsModal()" id="btn-settings" style="font-size:16px" title="Settings">&#9881;</button>
    </div>
  </header>

  <div class="status-bar">
    <span id="status-text">Loading...</span>
    <span id="last-updated"></span>
  </div>

  <div class="period-selector" style="margin-bottom:16px;display:flex;gap:4px;align-items:center">
    <span style="font-size:12px;color:var(--text-muted);margin-right:8px">Period:</span>
    <button class="btn period-btn active" data-period="all" onclick="setPeriod('all')">All Time</button>
    <button class="btn period-btn" data-period="7d" onclick="setPeriod('7d')">7 Days</button>
    <button class="btn period-btn" data-period="30d" onclick="setPeriod('30d')">30 Days</button>
    <button class="btn period-btn" data-period="90d" onclick="setPeriod('90d')">90 Days</button>
  </div>

  <div class="metrics-grid" id="metrics-grid"></div>

  <div class="panel">
    <div class="panel-header">Security Health Trend</div>
    <div class="panel-body" id="trend-chart"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
  </div>

  <div class="grid-2">
    <div class="panel">
      <div class="panel-header">Severity Breakdown</div>
      <div class="panel-body" id="severity-chart"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
    </div>
    <div class="panel">
      <div class="panel-header">Category Breakdown</div>
      <div class="panel-body" id="category-chart"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      Repositories Scanned
      <span id="repo-count" style="color:var(--text-muted);font-weight:400;font-size:12px;"></span>
    </div>
    <div class="panel-body" style="overflow-x:auto;" id="repos-table-container"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
  </div>

  <div class="panel">
    <div class="panel-header">
      Run History
      <span id="runs-count" style="color:var(--text-muted);font-weight:400;font-size:12px;"></span>
    </div>
    <div class="panel-body" style="overflow-x:auto;" id="runs-table-container"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
  </div>

  <div class="panel">
    <div class="panel-header">
      Devin Sessions
      <span id="sessions-count" style="color:var(--text-muted);font-weight:400;font-size:12px;"></span>
    </div>
    <div class="panel-body" style="overflow-x:auto;" id="sessions-table-container"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
  </div>

  <div class="panel">
    <div class="panel-header">
      Pull Requests
      <span id="prs-count" style="color:var(--text-muted);font-weight:400;font-size:12px;"></span>
    </div>
    <div class="panel-body" style="overflow-x:auto;" id="prs-table-container"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
  </div>

  <div class="panel">
    <div class="panel-header">
      Issue Tracking
      <span id="issues-count" style="color:var(--text-muted);font-weight:400;font-size:12px;"></span>
    </div>
    <div class="panel-body" style="overflow-x:auto;" id="issues-table-container"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
  </div>

  <div class="panel">
    <div class="panel-header">
      Scheduled Repo Registry
      <span id="registry-count" style="color:var(--text-muted);font-weight:400;font-size:12px;"></span>
    </div>
    <div class="panel-body" style="overflow-x:auto;" id="registry-table-container"><div class="table-loading"><span class="spinner"></span> Loading...</div></div>
  </div>
</div>

<div class="modal-overlay" id="dispatch-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>Trigger CodeQL Fixer Action</h2>
      <button class="modal-close" onclick="closeDispatchModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="warning-banner" id="dispatch-warning"></div>
      <div class="form-group">
        <label for="d-target-repo">Target Repository URL *</label>
        <input class="form-input" id="d-target-repo" type="text" value="" onchange="checkPreflightStatic()">
        <div class="hint">GitHub repository URL to analyze</div>
      </div>
      <div class="form-group">
        <label for="d-languages">Languages</label>
        <input class="form-input" id="d-languages" type="text" value="" placeholder="e.g. javascript,python">
        <div class="hint">Comma-separated CodeQL languages (leave empty for auto-detect)</div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="d-queries">Query Suite</label>
          <select class="form-input" id="d-queries">
            <option value="security-extended" selected>security-extended</option>
            <option value="security-and-quality">security-and-quality</option>
          </select>
        </div>
        <div class="form-group">
          <label for="d-severity">Severity Threshold</label>
          <select class="form-input" id="d-severity">
            <option value="critical">critical</option>
            <option value="high">high</option>
            <option value="medium">medium</option>
            <option value="low" selected>low</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="d-batch-size">Batch Size</label>
          <input class="form-input" id="d-batch-size" type="number" value="5" min="1">
          <div class="hint">Max issues per Devin session</div>
        </div>
        <div class="form-group">
          <label for="d-max-sessions">Max Sessions</label>
          <input class="form-input" id="d-max-sessions" type="number" value="5" min="1">
          <div class="hint">Max Devin sessions to create</div>
        </div>
      </div>
      <div class="form-group">
        <label for="d-default-branch">Default Branch</label>
        <input class="form-input" id="d-default-branch" type="text" value="main">
        <div class="hint">Default branch of the target repo</div>
      </div>
      <div class="form-group">
        <label for="d-include-paths">Include Paths</label>
        <input class="form-input" id="d-include-paths" type="text" value="" placeholder="e.g. src/**,lib/**">
        <div class="hint">Optional comma-separated globs to include</div>
      </div>
      <div class="form-group">
        <label for="d-exclude-paths">Exclude Paths</label>
        <input class="form-input" id="d-exclude-paths" type="text" value="" placeholder="e.g. test/**,vendor/**">
        <div class="hint">Optional comma-separated globs to exclude</div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-check">
            <input type="checkbox" id="d-persist-logs" checked>
            <span>Persist Logs</span>
          </label>
          <div class="hint">Keep logs in GitHub</div>
        </div>
        <div class="form-group">
          <label class="form-check">
            <input type="checkbox" id="d-dry-run">
            <span>Dry Run</span>
          </label>
          <div class="hint">Generate prompts only (no Devin sessions)</div>
        </div>
      </div>
      <div class="dispatch-result" id="dispatch-result"></div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeDispatchModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitDispatchStatic()" id="btn-submit-dispatch">Dispatch Workflow</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settings-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="s-gh-token">GitHub Token</label>
        <input class="form-input" id="s-gh-token" type="password" placeholder="ghp_...">
        <div class="hint">PAT with <code>repo</code> scope. Needed for PR discovery, refresh, and workflow dispatch. Stored in your browser only.</div>
      </div>
      <div class="form-group">
        <label for="s-devin-key">Devin API Key</label>
        <input class="form-input" id="s-devin-key" type="password" placeholder="Bearer token">
        <div class="hint">Devin API bearer token for polling session statuses. Stored in your browser only.</div>
      </div>
      <div class="form-group">
        <label for="s-action-repo">Action Repository</label>
        <input class="form-input" id="s-action-repo" type="text" placeholder="owner/repo">
        <div class="hint">The repo containing the telemetry data, e.g. <code>marius-posa/codeql-devin-fixer</code></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeSettingsModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<script src="static/api.js"></script>
<script src="static/shared.js"></script>
<script>
let allRuns = [];
let allSessions = [];
let allPrs = [];
let allRepos = [];
let allIssues = [];
let stats = {};
let registryData = null;
let currentPeriod = 'all';

window._cachedRuns = [];
window._cachedPrs = [];
window._cachedSessions = [];

function setPeriod(period) {
  currentPeriod = period;
  document.querySelectorAll('.period-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.period === period);
  });
  fetchAll();
}

function filterRunsByPeriod(runs, period) {
  if (!period || period === 'all') return runs;
  var daysMap = { '7d': 7, '30d': 30, '90d': 90 };
  var days = daysMap[period];
  if (!days) return runs;
  var cutoff = new Date(Date.now() - days * 86400000).toISOString();
  return runs.filter(function(r) { return (r.timestamp || '') >= cutoff; });
}

function renderMetrics(s) {
  const grid = document.getElementById('metrics-grid');
  const latestIssues = s.latest_issues != null ? s.latest_issues : s.total_issues;
  const issuesSub = s.total_runs > 1 && s.latest_issues != null
    ? latestIssues + ' current, ' + (s.total_issues || 0) + ' across all runs'
    : '';
  const periodLabel = currentPeriod !== 'all' ? ' (' + currentPeriod + ')' : '';
  const fixRate = s.fix_rate || 0;
  const cards = [
    { label: 'Repos Scanned', value: s.repos_scanned || 0, cls: 'blue' },
    { label: 'Total Runs' + periodLabel, value: s.total_runs || 0, cls: 'cyan' },
    { label: 'Issues Found' + periodLabel, value: latestIssues, cls: 'orange',
      sub: issuesSub },
    { label: 'Devin Sessions' + periodLabel, value: s.sessions_created || 0, cls: 'purple',
      sub: (s.sessions_finished || 0) + ' finished' },
    { label: 'PRs Created' + periodLabel, value: s.prs_total || 0, cls: 'blue',
      sub: (s.prs_merged || 0) + ' merged, ' + (s.prs_open || 0) + ' open' },
    { label: 'Fix Rate' + periodLabel, value: fixRate + '%', cls: fixRateColorClass(fixRate),
      sub: 'merged / total PRs' },
  ];
  grid.innerHTML = cards.map(function(c) {
    return '<div class="metric-card ' + c.cls + '">'
      + '<div class="label">' + c.label + '</div>'
      + '<div class="value">' + c.value + '</div>'
      + (c.sub ? '<div class="sub">' + c.sub + '</div>' : '')
      + '</div>';
  }).join('');
}

function renderReposTable(repos) {
  const el = document.getElementById('repos-table-container');
  document.getElementById('repo-count').textContent = repos.length;
  if (repos.length === 0) {
    el.innerHTML = '<div class="empty-state">No repos scanned yet</div>';
    return;
  }
  let rows = '';
  repos.forEach(function(r) {
    const short = escapeHtml(repoShort(r.repo));
    rows += '<tr>'
      + '<td><a href="repo.html?repo=' + encodeURIComponent(short) + '">' + short + '</a></td>'
      + '<td>' + r.runs + '</td>'
      + '<td>' + r.issues_found + '</td>'
      + '<td>' + r.sessions_created + (r.sessions_finished ? ' <span style="color:var(--accent-green);font-size:11px">(' + r.sessions_finished + ' done)</span>' : '') + '</td>'
      + '<td>' + r.prs_total + '</td>'
      + '<td>' + r.prs_merged + '</td>'
      + '<td>' + r.prs_open + '</td>'
      + '<td>' + formatDate(r.last_run) + '</td>'
      + '<td style="white-space:nowrap"><a class="btn" style="padding:2px 10px;font-size:11px" href="repo.html?repo=' + encodeURIComponent(short) + '">View</a> '
      + '<button class="btn" style="padding:2px 10px;font-size:11px;background:#1f6feb;border-color:#388bfd;color:#fff" onclick="openDispatchModal(this.dataset.repo)" data-repo="' + escapeHtml(r.repo) + '">Run</button></td>'
      + '</tr>';
  });
  el.innerHTML = '<table><thead><tr>'
    + '<th>Repository</th><th>Runs</th><th>Issues</th><th>Sessions</th>'
    + '<th>PRs</th><th>Merged</th><th>Open</th><th>Last Run</th><th></th>'
    + '</tr></thead><tbody>' + rows + '</tbody></table>';
}

function renderRunsTable(runs) {
  const el = document.getElementById('runs-table-container');
  document.getElementById('runs-count').textContent = runs.length;
  if (runs.length === 0) {
    el.innerHTML = '<div class="empty-state">No runs recorded yet. Trigger the action to see data here.</div>';
    return;
  }
  const sorted = [...runs].sort(function(a, b) { return (b.run_number || 0) - (a.run_number || 0); });
  let rows = '';
  sorted.forEach(function(r) {
    rows += '<tr>'
      + '<td><strong>#' + (r.run_number || '-') + '</strong></td>'
      + '<td><a href="' + escapeHtml(r.target_repo) + '" target="_blank">' + escapeHtml(repoShort(r.target_repo)) + '</a></td>'
      + '<td>' + (r.issues_found || 0) + '</td>'
      + '<td>' + (r.batches_created || 0) + '</td>'
      + '<td>' + (r.sessions || []).length + '</td>'
      + '<td>' + formatDate(r.timestamp) + '</td>'
      + '</tr>';
  });
  el.innerHTML = '<table><thead><tr>'
    + '<th>Run</th><th>Target Repo</th><th>Issues</th><th>Batches</th>'
    + '<th>Sessions</th><th>Timestamp</th>'
    + '</tr></thead><tbody>' + rows + '</tbody></table>';
}

function renderAll() {
  renderMetrics(stats);
  renderTrendChart(document.getElementById('trend-chart'), allRuns, 'dash');
  renderBarChart(document.getElementById('severity-chart'), stats.latest_severity || stats.severity_breakdown);
  renderBarChart(document.getElementById('category-chart'), stats.latest_category || stats.category_breakdown);
  renderReposTable(allRepos);
  renderRunsTable(allRuns);
  renderSessionsTable(allSessions, 'sessions-table-container', 'sessions-count');
  renderPrsTable(allPrs, 'prs-table-container', 'prs-count');
  renderIssuesTable(allIssues, 'issues-table-container', 'issues-count');
  if (registryData) renderRegistryTable(registryData, 'registry-table-container', 'registry-count');
}

async function fetchAll() {
  setStatus('Loading data from GitHub...');
  try {
    const runs = await loadRuns(false);
    const filteredRuns = filterRunsByPeriod(runs, currentPeriod);
    allRuns = filteredRuns;
    window._cachedRuns = runs;

    const sessions = aggregateSessions(filteredRuns);
    allSessions = sessions;
    window._cachedSessions = sessions;

    const prs = await fetchPrsFromGitHub(runs);
    allPrs = prs;
    window._cachedPrs = prs;

    linkPrsToSessions(sessions, prs);

    stats = aggregateStats(filteredRuns, sessions, prs);
    allRepos = buildReposDict(filteredRuns, sessions, prs);
    allIssues = trackIssuesAcrossRuns(filteredRuns);

    registryData = await fetchRegistry();

    renderAll();
    setStatus('Ready');
    setUpdated();
  } catch (e) {
    setStatus('Error: ' + e.message);
    console.error(e);
  }
}

async function pollSessions() {
  const btn = document.getElementById('btn-poll');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Polling...';
  setStatus('Triggering server-side session poll...');
  try {
    const result = await triggerPollWorkflow();
    if (result.error) {
      setStatus('Poll error: ' + result.error);
      btn.disabled = false;
      btn.textContent = 'Poll Sessions';
      return;
    }
    setStatus('Poll workflow dispatched, waiting for completion...');
    const waitResult = await waitForPollWorkflow(120000);
    if (waitResult.error) {
      setStatus('Poll warning: ' + waitResult.error);
    } else {
      setStatus('Poll workflow completed (' + (waitResult.conclusion || 'done') + '). Refreshing data...');
    }

    _runsCache = null;
    const runs = await loadRuns(true);
    allRuns = runs;
    window._cachedRuns = runs;

    const sessions = aggregateSessions(runs);
    allSessions = sessions;
    window._cachedSessions = sessions;

    const prs = await fetchPrsFromGitHub(runs);
    allPrs = prs;
    window._cachedPrs = prs;
    linkPrsToSessions(sessions, prs);

    stats = aggregateStats(runs, sessions, prs);
    allRepos = buildReposDict(runs, sessions, prs);
    allIssues = trackIssuesAcrossRuns(runs);
    renderAll();
    setStatus('Polled ' + sessions.length + ' sessions, found ' + prs.length + ' PRs');
    setUpdated();
  } catch (e) {
    setStatus('Poll error: ' + e.message);
  }
  btn.disabled = false;
  btn.textContent = 'Poll Sessions';
}

async function refreshData() {
  const btn = document.getElementById('btn-refresh');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Refreshing...';
  setStatus('Pulling latest telemetry data...');
  try {
    _runsCache = null;
    const runs = await loadRuns(true);
    allRuns = runs;
    window._cachedRuns = runs;

    const sessions = aggregateSessions(runs);
    allSessions = sessions;
    window._cachedSessions = sessions;

    const prs = await fetchPrsFromGitHub(runs);
    allPrs = prs;
    window._cachedPrs = prs;
    linkPrsToSessions(sessions, prs);

    stats = aggregateStats(runs, sessions, prs);
    allRepos = buildReposDict(runs, sessions, prs);
    allIssues = trackIssuesAcrossRuns(runs);

    renderAll();
    setStatus('Refreshed - ' + runs.length + ' run files, ' + prs.length + ' PRs');
    setUpdated();
  } catch (e) {
    setStatus('Refresh error: ' + e.message);
  }
  btn.disabled = false;
  btn.textContent = 'Refresh Data';
}

async function init() {
  var cfg = getConfig();
  var warnings = [];
  if (!cfg.githubToken) warnings.push('GitHub token not set - PR discovery and refresh limited');
  await fetchAll();
  if (warnings.length > 0) setStatus(warnings.join(' | ') + ' (click Settings to configure)');
}
init();
</script>
</body>
</html>
